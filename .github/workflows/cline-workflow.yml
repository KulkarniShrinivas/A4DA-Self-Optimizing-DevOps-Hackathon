name: A4DA Autonomous Pipeline (Cline Integration)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  run-cline-automation:
    name: 1. Deploy & Trigger Data Flow
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js & Install CLIs
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          npm install -g cline
          npm install -g vercel
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Run Cline Deployment Workflow
        run: |
          # FINAL FIX FOR AUTH: Must include provider and model ID
          cline auth --apikey ${{ secrets.CLINE_API_KEY }} --provider openai-native --modelid gpt-4o
          
          chmod +x .github/scripts/deploy_and_trigger.sh
          chmod +x .github/scripts/get_kestra_jwt.sh
          
          # Execute the deployment script
          .github/scripts/deploy_and_trigger.sh
        env:
          CLINE_API_KEY: ${{ secrets.CLINE_API_KEY }} 
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }} 
          KESTRA_USERNAME: ${{ secrets.KESTRA_USERNAME }} 
          KESTRA_PASSWORD: ${{ secrets.KESTRA_PASSWORD }} 
          KESTRA_BASE_URL: ${{ secrets.KESTRA_BASE_URL }}
          GITHUB_SHA: ${{ github.sha }}

  autofix-job:
    name: 2. Autonomous Code Style Fixer
    runs-on: ubuntu-latest
    needs: run-cline-automation
    
    
    permissions:
      contents: write 
      pull-requests: write # Required to create the Pull Request
      
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN_FOR_PR }} 
          
      - name: Setup Node.js & Install CLIs
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          npm install -g cline
          # CRITICAL FIX 2: Install the official GitHub CLI (gh) using the recommended method for CI
          npm install -g @cli/cli # The command line tool is named 'gh' 
          sudo apt-get update
          sudo apt-get install -y jq
        
      # Removed unnecessary NODE_AUTH_TOKEN line here as it was unused and confusing

      - name: Configure Git User
        run: |
          git config user.name "A4DA-AutoFix-Agent"
          git config user.email "a4da-agent@hackathon.com"

      - name: Run Cline AutoFix Agent and Create PR
        run: |
          # FIX: Authenticate Cline for the 'ask' command
          cline auth --apikey ${{ secrets.CLINE_API_KEY }} --provider openai-native --modelid gpt-4o
          
          BRANCH_NAME="autofix/${{ github.run_number }}"
          git checkout -b "$BRANCH_NAME"

          # Ask Cline to fix style issues, commit to the new branch
          # NOTE: Removed --yolo from 'cline ask' as it's intended to be used with 'cline run'
          cline ask --model gpt-4o "Find and fix all code style issues in ./src/utils.js. Commit the changes to the current branch."

          # Push the changes
          # The token in "secrets.GH_TOKEN_FOR_PR" must have 'repo' scope for push/PR
          git push -u origin $BRANCH_NAME

          # Create Pull Request using gh CLI
          gh pr create \
            --title "ðŸ¤– A4DA AutoFix: Autonomous Code Style Correction" \
            --body "The Cline AutoFix Agent detected and fixed code style issues in 'src/utils.js'. This demonstrates the A4DA's autonomous maintenance capability." \
            --base main \
            --head "$BRANCH_NAME" \
            --repo ${{ github.repository }}
        env:
          CLINE_API_KEY: ${{ secrets.CLINE_API_KEY }}
          # GITHUB_TOKEN is required by gh CLI for authentication
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN_FOR_PR }} 

  notify-completion:
    name: 3. Notify on Workflow Completion
    runs-on: ubuntu-latest
    needs: [run-cline-automation, autofix-job]
    steps:
      - name: Send Completion Notification
        run: |
          echo "A4DA Autonomous Pipeline (Cline Integration) has completed successfully."
        env:
          NOTIFICATION_WEBHOOK_URL: ${{ secrets.NOTIFICATION_WEBHOOK_URL }}